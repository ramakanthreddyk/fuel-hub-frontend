# STEP\_2\_4\_COMMAND.md â€” Nozzle Readings + Auto Sales Generation

## âœ… Project Context Summary

FuelSync Hub is a fuel station ERP system where each nozzle reading is a cumulative value. Sales entries are automatically generated by calculating deltas between consecutive readings. Each sale uses the price effective at the reading time.

## ðŸ“Œ Prior Steps Implemented

* âœ… `STEP_2_3`: Station, pump, and nozzle APIs + plan enforcement
* âœ… `STEP_2_2`: Tenant user management
* âœ… `STEP_2_1`: Auth, JWT, role middleware
* âœ… Phase 1: Full database schema with `nozzle_readings`, `sales`, `fuel_prices`

## ðŸš§ What to Build Now

### 1. Endpoint: `POST /api/nozzle-readings`

* Fields: `nozzle_id`, `reading`, `recorded_at`
* Must validate:

  * Reading is >= last value for that nozzle
  * Same nozzle and tenant context
* On insert, auto-generate delta:

  ```ts
  volume_sold = new_reading - previous_reading
  sale_amount = volume_sold Ã— price_at(recorded_at)
  ```
* Insert resulting row into `sales` table

### 2. Delta Logic

* Load last reading (if exists)
* Load price using:

  ```sql
  SELECT price FROM fuel_prices
  WHERE fuel_type = nozzle.fuel_type
  AND station_id = nozzle.station_id
  AND effective_from <= recorded_at
  ORDER BY effective_from DESC
  LIMIT 1;
  ```
* Round sale to 2 decimals

### 3. Endpoint: `GET /api/nozzle-readings`

* Filter by station, nozzle, or date range
* Must enforce station access for current user

## ðŸ“ File Paths

```
src/
â”œâ”€â”€ controllers/nozzleReading.controller.ts
â”œâ”€â”€ routes/nozzleReading.route.ts
â”œâ”€â”€ services/nozzleReading.service.ts
â”œâ”€â”€ validators/nozzleReading.validator.ts
```

## ðŸ§  Why This Step

Nozzle readings are the operational backbone. Sales are never entered manually â€” theyâ€™re derived. This enforces accountability and ensures pricing alignment.

## ðŸ§¾ Docs To Update

* `CHANGELOG.md`: Feature â€” nozzle reading API + sales auto-generation
* `PHASE_2_SUMMARY.md`: Mark step complete
* `IMPLEMENTATION_INDEX.md`: Add STEP\_2\_4 with links
* `BUSINESS_RULES.md`: Confirm rules for reading deltas + pricing

---

> Once saved, execute changes in defined files and document all results before advancing.
